<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://unpkg.com/d3-3d/build/d3-3d.min.js"></script>
<body>
<style type="text/css">
button {
    position: absolute;
    right: 10px;
    top: 10px;
}
</style>
<button>update</button>
<svg width="960" height="500"></svg>
<script>

    var origin = [480, 250], j = 150, points = [], alpha = 0, beta = 0, startAngle = Math.PI/4;
    var svg    = d3.select('svg').call(d3.drag().on('drag', dragged).on('start', dragStart).on('end', dragEnd)).append('g');
    var mx, my, mouseX, mouseY;

    var myData = [[16,-0.29218106995884774,3],[14,-0.27946127946127947,5],[10,-0.04526748971193416,5],[14,-0.2054794520547945,6],[9,-0.4666666666666667,6],[16,-0.45871559633027525,9],[13,-0.5217391304347826,9],[9,-0.2222222222222222,9],[16,-0.49295774647887325,9],[14,-0.22631578947368422,9],[7,-0.37583892617449666,9],[10,-0.42592592592592593,5],[20,-1,10],[17,-0.41739130434782606,10],[20,0.6870503597122302,10],[13,-0.22020725388601037,10],[10,-0.09782608695652174,10],[20,-1,4],[14,-0.27450980392156865,4],[18,-0.7017543859649122,7],[13,-0.1308139534883721,7],[19,-0.6857142857142857,6],[17,-0.5945945945945946,6],[14,-0.23039215686274508,10],[14,-0.5445544554455446,9],[17,-0.5652173913043478,8],[15,-0.266025641025641,8],[16,-0.5238095238095238,5],[12,-0.04714640198511166,5],[13,-0.6363636363636364,10],[9,-0.17699115044247787,10],[19,-0.625,4],[16,-0.5370370370370371,4],[12,-0.0625,4],[10,-0.10822510822510822,4],[14,-0.5433070866141733,5],[19,-0.76,7],[10,-0.02867383512544803,7],[19,0.452755905511811,7],[11,0.04132231404958678,7],[16,-0.36082474226804123,7],[20,-1,9],[10,-0.10437710437710437,9],[8,-0.24528301886792453,9],[11,-0.008547008547008548,3],[19,-0.7575757575757576,2],[17,-0.5227272727272727,2],[14,-0.24819277108433735,2],[14,-0.42765273311897106,4],[11,-0.04632152588555858,4],[16,-0.3686635944700461,4],[17,-0.3716216216216216,10],[11,-0.02857142857142857,10],[12,-0.5555555555555556,5],[9,-0.4520547945205479,9],[17,-0.22625698324022347,6],[8,-0.7058823529411765,6],[14,-0.2028301886792453,8],[12,-0.046703296703296704,8],[16,-0.3709090909090909,2],[13,-0.19121447028423771,2],[20,-1,6],[16,-0.6304347826086957,6],[11,0.03070175438596491,6],[5,-0.10909090909090909,6],[17,-0.5833333333333334,5],[13,-0.11246200607902736,5],[14,-0.4,8],[6,-0.37,8],[15,-0.5733333333333334,8],[11,-0.5609756097560976,4],[17,-0.5714285714285714,3],[15,-0.2953216374269006,3],[5,-0.4,3],[16,-0.28901734104046245,6],[14,-0.5151515151515151,2],[18,-0.6046511627906976,2],[11,-0.30434782608695654,3],[16,-0.4876847290640394,2],[11,0.058981233243967826,2],[20,0.583011583011583,4],[15,-0.3469387755102041,4],[13,-0.21689497716894976,4],[8,-0.1921182266009852,4],[17,-0.5263157894736842,7],[14,-0.2826086956521739,7],[11,-0.2972972972972973,2],[17,-0.8775510204081632,4],[8,-0.2641509433962264,5],[5,-0.36666666666666664,3],[13,-0.24033149171270718,6],[10,-0.11551155115511551,6],[13,-0.5362318840579711,6],[17,-0.5116279069767442,9],[12,-0.14414414414414414,9],[15,-0.3602941176470588,2],[13,-0.2916666666666667,4],[15,-0.6,4],[18,-0.6538461538461539,3],[10,-0.10674157303370786,3],[17,-0.2974828375286041,2],[12,-0.16458852867830423,2],[12,-0.05869074492099323,10],[9,-0.7027027027027027,5],[12,-0.43333333333333335,4],[17,-0.24449877750611246,8],[15,-0.2786458333333333,10],[20,-1,3],[17,-0.25526315789473686,4],[18,0.03367875647668394,3],[12,-0.07425742574257425,3],[10,-0.5,7],[19,0.37822349570200575,4],[19,-0.9444444444444444,9],[15,-0.24603174603174602,9],[11,-0.014792899408284023,9],[16,-0.35843373493975905,10],[8,-0.2833333333333333,10],[10,-0.391304347826087,6],[11,-0.4418604651162791,7],[16,-0.34491315136476425,5],[13,-0.3617021276595745,7],[10,-0.0790273556231003,8],[20,0.6244131455399061,6],[18,-0.7291666666666666,6],[8,-0.5053763440860215,10],[20,-1,8],[11,0.028481012658227847,8],[7,-0.1893939393939394,8],[15,-0.24074074074074073,6],[6,-0.0990990990990991,2],[4,-0.6666666666666666,2],[8,-0.34210526315789475,9],[15,-0.3522727272727273,5],[18,-0.9090909090909091,9],[18,-0.7241379310344828,4],[10,-0.7058823529411765,8],[15,-0.5104895104895105,3],[15,-0.7142857142857143,2],[7,-0.21212121212121213,2],[13,-0.07565011820330969,3],[18,-0.5652173913043478,5],[13,-0.41284403669724773,5],[8,-0.16326530612244897,3],[15,-0.28125,7],[15,-0.5641025641025641,10],[15,-0.4520547945205479,7],[20,0.7241379310344828,8],[16,-0.43548387096774194,8],[13,-0.6585365853658537,3],[16,-0.3624454148471616,7],[9,-0.1910828025477707,2],[8,-0.37349397590361444,6],[19,0.3310344827586207,6],[11,-0.5609756097560976,9],[8,-0.9,5],[12,-0.47058823529411764,9],[10,0,2],[14,-0.353099730458221,7],[10,-0.7142857142857143,10],[17,-0.19130434782608696,7],[9,-0.92,10],[11,-0.29914529914529914,6],[15,-0.28700906344410876,5],[18,0.05228758169934641,5],[11,-0.4375,10],[8,-0.5652173913043478,4],[12,-0.52,3],[7,-0.45454545454545453,6],[12,-0.6216216216216216,10],[18,0.022988505747126436,4],[18,-0.5416666666666666,10],[12,-0.4489795918367347,8],[8,-0.1962025316455696,8],[10,-0.5220125786163522,3],[6,-0.7333333333333333,2],[6,-0.12371134020618557,4],[19,0.378125,9],[16,-0.5670103092783505,10],[18,0.17667844522968199,7],[9,-0.10062893081761007,7],[16,-0.4732142857142857,3],[13,-0.12871287128712872,8],[6,-0.18691588785046728,6],[18,0,9],[12,-0.07591623036649214,6],[18,-0.6585365853658537,8],[9,-0.4090909090909091,2],[19,-0.7037037037037037,5],[11,0.034482758620689655,5],[19,-0.8571428571428571,10],[10,-0.4942528735632184,4],[5,-0.8,6],[6,-0.36,6],[9,-0.4362934362934363,5],[7,-0.3825503355704698,6],[9,-0.2966101694915254,3],[16,-0.42272727272727273,8],[17,-0.3059125964010283,3],[8,-0.01020408163265306,2],[18,0.20718232044198895,8],[15,-0.48148148148148145,9],[8,-0.08163265306122448,7],[15,-0.375,6],[17,-0.22666666666666666,5],[5,-0.047619047619047616,10],[13,-0.35802469135802467,2],[8,-0.2,3],[4,-0.4117647058823529,2],[10,-0.5454545454545454,9],[12,-0.2459016393442623,6],[7,-0.24489795918367346,4],[5,-0.6507936507936508,10],[12,-0.5094339622641509,2],[18,-0.08083140877598152,10],[8,-0.36363636363636365,2],[9,-0.21115537848605578,4],[8,-0.4461538461538462,8],[4,-0.2,7],[7,-0.2972972972972973,5],[9,-0.6923076923076923,4],[9,-0.5757575757575758,3],[11,-0.4909090909090909,5],[11,-0.6491228070175439,8],[5,-0.3787878787878788,7],[19,-0.6585365853658537,3],[17,-0.375,9],[6,-0.4117647058823529,4],[4,-0.21212121212121213,4],[20,-1,7],[12,-0.03170028818443804,7],[19,-0.918918918918919,8],[14,-0.2631578947368421,6],[13,-0.49019607843137253,8],[9,-0.3076923076923077,6],[14,-0.7192982456140351,10],[13,-0.49622166246851385,9],[8,-0.5813953488372093,7],[5,-0.09230769230769231,5],[7,-0.2440944881889764,5],[4,-0.16666666666666666,3],[6,-0.696969696969697,8],[12,-0.3548387096774194,7],[7,-0.2672413793103448,10],[19,0.35446685878962536,3],[18,-0.016713091922005572,2],[10,-0.41007194244604317,2],[19,0.5375375375375375,8],[7,-0.4166666666666667,7],[5,-0.25675675675675674,9],[7,-0.3931034482758621,7],[20,0.6337579617834395,3],[9,-0.15725806451612903,8],[5,-0.6666666666666666,9],[19,0.29873417721518986,10],[20,-1,2],[14,-0.2948717948717949,3],[9,-0.48148148148148145,8],[7,-0.08620689655172414,3],[9,-0.49514563106796117,7],[7,-0.46153846153846156,4],[7,-0.5333333333333333,8],[14,-0.48484848484848486,3],[7,-0.48148148148148145,9],[5,-0.5714285714285714,4],[6,-0.3670886075949367,3],[5,-0.6,5],[6,-0.2,10],[6,-0.6428571428571429,5],[7,-0.45098039215686275,2],[5,-0.2558139534883721,2],[6,-0.3888888888888889,7],[5,-0.5,7],[6,-0.3391304347826087,7],[7,-0.46296296296296297,3],[19,0.34146341463414637,2],[6,-0.5,9],[5,-0.42857142857142855,8],[4,-0.375,8],[18,0.047619047619047616,6],[6,-0.5714285714285714,5],[20,0.6631578947368421,2],[5,-1,2],[20,0.6954732510288066,9],[20,0.7281553398058253,7],[6,-0.47368421052631576,9],[4,-0.5,4],[5,-0.14814814814814814,8],[4,-0.38461538461538464,7],[6,-0.5882352941176471,3],[6,-0.5625,10],[19,0.2682926829268293,5],[4,-0.2903225806451613,8],[20,-1,5],[4,-1,9],[7,-0.47619047619047616,10],[4,-0.10714285714285714,5],[5,-0.4603174603174603,4],[4,-0.4090909090909091,9],[4,-0.4166666666666667,3],[20,0.5771144278606966,5],[4,-0.25,6],[4,-1,10],[4,-0.40540540540540543,10],[4,-0.25,6],[4,-0.38461538461538464,5]];
    var myData2 = myData.map(d => [d[0], d[2], d[1]]);

    var surface = d3._3d()
        .scale(10)
        .x(function(d){ return d.x; })
        .y(function(d){ return d.y; })
        .z(function(d){ return d.z; })
        .origin(origin)
        .rotateY(startAngle)
        .rotateX(-startAngle)
        .shape('SURFACE', 154);

    var color = d3.scaleLinear();

    function processData(data, tt){

        var planes = svg.selectAll('path').data(data, function(d){ return d.plane; });

        planes
            .enter()
            .append('path')
            .attr('class', '_3d')
            .attr('fill', colorize)
            .attr('opacity', 0)
            .attr('stroke-opacity', 0.1)
            .merge(planes)
            .attr('stroke', 'black')
            .transition().duration(tt)
            .attr('opacity', 1)
            .attr('fill', colorize)
            .attr('d', surface.draw);

        planes.exit().remove();

        d3.selectAll('._3d').sort(surface.sort);

    }

    function colorize(d){
        var _y = (d[0].y + d[1].y + d[2].y + d[3].y)/4;
        var col = d.ccw ? d3.interpolateSpectral(color(_y)) : d3.color(d3.interpolateSpectral(color(_y))).darker(2.5);
        return col;
    }

    function dragStart(){
        mx = d3.event.x;
        my = d3.event.y;
    }

    function dragged(){
        mouseX = mouseX || 0;
        mouseY = mouseY || 0;
        beta   = (d3.event.x - mx + mouseX) * Math.PI / 230 ;
        alpha  = (d3.event.y - my + mouseY) * Math.PI / 230  * (-1);
        processData(surface.rotateY(beta + startAngle).rotateX(alpha - startAngle)(points), 0);
    }

    function dragEnd(){
        mouseX = d3.event.x - mx + mouseX;
        mouseY = d3.event.y - my + mouseY;
    }

    function init(eq){
        points = [];

        var minX = Math.min.apply(null, myData.map(d=>d[0]));
        var maxX = Math.max.apply(null, myData.map(d=>d[0]));

        var minZ = Math.min.apply(null, myData.map(d=>d[2]));
        var maxZ = Math.max.apply(null, myData.map(d=>d[2]));

        for(var z = minZ; z <= maxZ; z++){
            for(var x = minX; x <= maxX; x++){
                var d = (myData2[x]) ? myData[x][z] : 0;
                points.push({x: x, y: d ? d*10 : 0, z: z});

            }
        }

        console.log(points);

        var yMin = d3.min(points, function(d){ return d.y; });
        var yMax = d3.max(points, function(d){ return d.y; });

        color.domain([yMin, yMax]);
        processData(surface(points), 1000);
    }

    function change(){
        var rn1 = Math.floor(d3.randomUniform(1, 12)());
        var eqa = function(x, z){
            return Math.cos(Math.sqrt(x*x+z*z)/5*Math.PI)*rn1;
        };
        init(eqa);
    }

    d3.selectAll('button').on('click', change);

    change();

</script>
</body>
